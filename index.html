<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Enigma Machine Demo</title>
    </head>

    <body>
        <div class="split">
            <div class="keyboards">
                <div class="keyboard lightboard">
                    <div class="row-1">
                        <span>Q</span>
                        <span>W</span>
                        <span>E</span>
                        <span>R</span>
                        <span>T</span>
                        <span>Y</span>
                        <span>U</span>
                        <span>I</span>
                        <span>O</span>
                        <span>P</span>
                    </div>
        
                    <div class="row-2">
                        <span>A</span>
                        <span>S</span>
                        <span>D</span>
                        <span>F</span>
                        <span>G</span>
                        <span>H</span>
                        <span>J</span>
                        <span>K</span>
                        <span>L</span>
                    </div>
        
                    <div class="row-3">
                        <span>Z</span>
                        <span>X</span>
                        <span>C</span>
                        <span>V</span>
                        <span>B</span>
                        <span>N</span>
                        <span>M</span>
                    </div>
                </div>
        
                <div class="keyboard pressboard">
                    <div class="row-1">
                        <button onClick="virtualKeyPress()">Q</button>
                        <button onClick="virtualKeyPress()">W</button>
                        <button onClick="virtualKeyPress()">E</button>
                        <button onClick="virtualKeyPress()">R</button>
                        <button onClick="virtualKeyPress()">T</button>
                        <button onClick="virtualKeyPress()">Y</button>
                        <button onClick="virtualKeyPress()">U</button>
                        <button onClick="virtualKeyPress()">I</button>
                        <button onClick="virtualKeyPress()">O</button>
                        <button onClick="virtualKeyPress()">P</button>
                    </div>
        
                    <div class="row-2">
                        <button onClick="virtualKeyPress()">A</button>
                        <button onClick="virtualKeyPress()">S</button>
                        <button onClick="virtualKeyPress()">D</button>
                        <button onClick="virtualKeyPress()">F</button>
                        <button onClick="virtualKeyPress()">G</button>
                        <button onClick="virtualKeyPress()">H</button>
                        <button onClick="virtualKeyPress()">J</button>
                        <button onClick="virtualKeyPress()">K</button>
                        <button onClick="virtualKeyPress()">L</button>
                    </div>
        
                    <div class="row-3">
                        <button onClick="virtualKeyPress()">Z</button>
                        <button onClick="virtualKeyPress()">X</button>
                        <button onClick="virtualKeyPress()">C</button>
                        <button onClick="virtualKeyPress()">V</button>
                        <button onClick="virtualKeyPress()">B</button>
                        <button onClick="virtualKeyPress()">N</button>
                        <button onClick="virtualKeyPress()">M</button>
                    </div>
                </div>
            </div>

            <div class="settings">
                <div class="keyboard plugboard">
                    <div class="row-1">
                        <button onClick="virtualKeyPress()">Q</button>
                        <button onClick="virtualKeyPress()">W</button>
                        <button onClick="virtualKeyPress()">E</button>
                        <button onClick="virtualKeyPress()">R</button>
                        <button onClick="virtualKeyPress()">T</button>
                        <button onClick="virtualKeyPress()">Y</button>
                        <button onClick="virtualKeyPress()">U</button>
                        <button onClick="virtualKeyPress()">I</button>
                        <button onClick="virtualKeyPress()">O</button>
                        <button onClick="virtualKeyPress()">P</button>
                    </div>
        
                    <div class="row-2">
                        <button onClick="virtualKeyPress()">A</button>
                        <button onClick="virtualKeyPress()">S</button>
                        <button onClick="virtualKeyPress()">D</button>
                        <button onClick="virtualKeyPress()">F</button>
                        <button onClick="virtualKeyPress()">G</button>
                        <button onClick="virtualKeyPress()">H</button>
                        <button onClick="virtualKeyPress()">J</button>
                        <button onClick="virtualKeyPress()">K</button>
                        <button onClick="virtualKeyPress()">L</button>
                    </div>
        
                    <div class="row-3">
                        <button onClick="virtualKeyPress()">Z</button>
                        <button onClick="virtualKeyPress()">X</button>
                        <button onClick="virtualKeyPress()">C</button>
                        <button onClick="virtualKeyPress()">V</button>
                        <button onClick="virtualKeyPress()">B</button>
                        <button onClick="virtualKeyPress()">N</button>
                        <button onClick="virtualKeyPress()">M</button>
                    </div>
                </div>
            </div>
        </div>
        

        <textarea id="output-textbox" readonly></textarea>

        

    </body>

    <style>
        .keyboard {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .row-1 {
            display: flex;
        }

        .pressboard button {
            padding: 10px;
            margin: 5px;
            font-size: 16px;
        }

        .plugboard button {
            display: inline-block;
            padding: 10px;
            margin: 5px;
            font-size: 16px;
            border: 1px solid black;
            border-radius: 4px;
            background-color: gray;
        }

        .lightboard span {
            display: inline-block;
            padding: 10px;
            margin: 5px;
            font-size: 16px;
            border: 1px solid black;
            border-radius: 4px;
            background-color: gray;
        }

        .split {
            display: flex;
            flex-direction: row;
            justify-content: center;
        }

        .keyboards {
            margin: 20px;
        }

        .settings {
            margin: 20px;
        }

        #output-textbox {
            margin-top: 20px;
            padding: 10px;
            font-size: 16px;
            margin-left: auto;
            margin-right: auto;
            resize: none;
            display: block;
        }
    </style>

    <script>
        var lightboard = document.getElementsByClassName("lightboard")[0];
        var plugboard = document.getElementsByClassName("plugboard")[0];
        var lightboardKeys = lightboard.getElementsByTagName("span");
        var plugboardKeys = plugboard.getElementsByTagName("button");
        var outputTextbox = document.getElementById("output-textbox");

        var lightboardDict = {};
        var plugboardDict = {};

        for (var i = 0; i < lightboardKeys.length; i++) {
            lightboardDict[lightboardKeys[i].innerText] = lightboardKeys[i];
        }


        for (var i = 0; i < plugboardKeys.length; i++) {
            plugboardDict[plugboardKeys[i].innerText] = plugboardKeys[i];
        }

        var defPlugBoardSettings = {}

        var defReflector = {
            "A": "Y",
            "B": "R",
            "C": "U", 
        };

        var defRotorSettings = {
            "A": [1, "Q", "EKMFLGDQVZNTOWYHXUSPAIBRCJ"],
            "B": [1, "E", "AJDKSIRUXBLHWTMCQGZNPYFVOE"],
            "C": [1, "V", "BDFHJLCPRTXVZNYEIWGAKMUSQO"],
        };

        var plugBoardSettings = {};
        var reflector = {};
        var rotorSettings = {};

        function saveSettings(pb, rf, rs) {
            if (pb) {
                localStorage.setItem("plugBoardSettings", JSON.stringify(pb));
            }

            if (rf) {
                localStorage.setItem("reflector", JSON.stringify(rf));
            }

            if (rs) {
                localStorage.setItem("rotorSettings", JSON.stringify(rs));
            }
        }

        function loadSettings() {
            var pb = JSON.parse(localStorage.getItem("plugBoardSettings"));
            var rf = JSON.parse(localStorage.getItem("reflector"));
            var rs = JSON.parse(localStorage.getItem("rotorSettings"));

            plugBoardSettings = pb || defPlugBoardSettings;
            reflector = rf || defReflector;
            rotorSettings = rs || defRotorSettings;

            console.log(JSON.stringify(plugBoardSettings), JSON.stringify(reflector), JSON.stringify(rotorSettings))
        }

        function rotateRotor(rotor) {
            rotor[0] = (rotor[0] % 26) + 1;
        }

        function plugBoard(input) {
            return plugBoardSettings[input] || input;
        }

        function rotorHandle(rotor, input) {
            var offset = rotor[0] - 1;

            return rotor[2][(input.charCodeAt(0) - 65 + offset) % 26];
        }

        function reflect(input) {
            return reflector[input] || input;
        }

        function rotors(input) {
            rotateRotor(rotorSettings["C"]);

            if (rotorSettings["C"][0] % 26 === 0) {
                rotateRotor(rotorSettings["B"]);
                if (rotorSettings["B"][0] % 26 === 0) {
                    rotateRotor(rotorSettings["A"]);
                }
            }

            var outputA = rotorHandle(rotorSettings["A"], input);
            var outputB = rotorHandle(rotorSettings["B"], outputA);
            var outputC = rotorHandle(rotorSettings["C"], outputB);

            var reflected = reflect(outputC);

            var outputCR = rotorHandle(rotorSettings["C"], reflected);
            var outputBR = rotorHandle(rotorSettings["B"], outputC);
            var outputAR = rotorHandle(rotorSettings["A"], outputB);

            return outputAR;
        }

        function virtualKeyPress() {
            loadSettings();

            var element = event.target;
            var keyFinal = element.innerText;

            keyFinal = plugBoard(keyFinal);
            keyFinal = rotors(keyFinal);
            keyFinal = plugBoard(keyFinal);

            var lightKey = lightboardDict[keyFinal];

            lightKey.style.backgroundColor = "yellow";
            setTimeout(function() {
                lightKey.style.backgroundColor = "gray";
            }, 750);

            outputTextbox.value += keyFinal;
        }

        function init() {
            localStorage.removeItem("plugLastKey");
            localStorage.removeItem("plugBoardSettings");
            localStorage.removeItem("reflector");
            localStorage.removeItem("rotorSettings");

            outputTextbox.value = "";
        }

        function plugboardPress() {
            var element = event.target;
            var keyFinal = element.innerText;

            var lastKey = localStorage.getItem("plugLastKey");

            if (lastKey && lastKey !== keyFinal) {
                console.log(lastKey);
                console.log(plugboardDict, plugboardDict[lastKey])

                var last = plugboardDict[lastKey];
                var current = plugboardDict[keyFinal];

                var cable = document.createElement("div");
                cable.style.position = "absolute";
                cable.style.width = "6px";
                cable.style.backgroundColor = "black";

                var x1 = last.offsetLeft + last.offsetWidth / 2;
                var y1 = last.offsetTop + last.offsetHeight / 2;
                var x2 = current.offsetLeft + current.offsetWidth / 2;
                var y2 = current.offsetTop + current.offsetHeight / 2;

                var length = Math.sqrt(
                    Math.pow(x2 - x1, 2) + 
                    Math.pow(y2 - y1, 2)
                );

                cable.style.height = length + "px";
                cable.style.left = x1 + "px";
                cable.style.top = y1 + "px";

                var theta = Math.atan2(y2 - y1, x2 - x1) - Math.PI/2;
                cable.style.transformOrigin = "center top";
                cable.style.transform = "rotate(" + theta + "rad)";

                plugBoardSettings[lastKey] = keyFinal;
                
                saveSettings(plugBoardSettings, null, null)

                document.body.appendChild(cable);

                localStorage.removeItem("plugLastKey");
            } else {
                localStorage.setItem("plugLastKey", keyFinal);
            }
        }

        window.onload = init;
        var element = event.target;

        if (element.parentElement.parentElement.className === "keyboard plugboard") {
            plugboardPress();
        } else {
            virtualKeyPress();
        }
    </script>
</html>